name: Go CI

on: [push, pull_request]

jobs:
  test-build-lint:
    runs-on: ubuntu-latest

    env:
      AIRTABLE_BASE_ID: dummy
      AIRTABLE_MEDICINES_TABLE: dummy
      AIRTABLE_ENTRIES_TABLE: dummy
      AIRTABLE_TOKEN: dummy
      TELEGRAM_BOT_TOKEN: dummy
      TELEGRAM_CHAT_ID: dummy
      ENABLE_ENTRY_POST: false
      ENABLE_ALERT_TICKER: false
      ENABLE_TELEGRAM_POLLING: false

    defaults:
      run:
        working-directory: backend

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24.1'

      - name: ğŸ” Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: ${{ runner.os }}-go-

      - name: âœ… Run unit tests
        run: go test -v ./...

      - name: ğŸ§± Build binary
        run: go build ./...

      - name: ğŸ§¹ Run golangci-lint
        uses: golangci/golangci-lint-action@v5
        with:
          version: v1.64.8
          working-directory: backend

  docker-build:
    runs-on: ubuntu-latest
    needs: test-build-lint

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ³ Docker Build
        run: docker build -f Dockerfile -t medicine-tracker .
